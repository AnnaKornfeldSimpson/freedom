<!DOCTYPE html>
<html lang="en-US">
<head>
  <title>File Drop</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
  <style type="text/css">
  body {
    padding-top: 20px;
    padding-bottom: 40px;
  }

  /* Custom container */
  .container-narrow {
    margin: 0 auto;
    max-width: 700px;
  }
  .container-narrow > hr {
    margin: 30px 0;
  }

  /* Main marketing message and sign up button */
  .jumbotron {
    margin: 60px 0;
    text-align: center;

    border: 2px dashed #555;
    border-radius: 20px;
    cursor: default;
    padding: 1em 0;
  }
  .jumbotron h1 {
    font-size: 72px;
    line-height: 1;
  }
  .jumbotron .btn {
    font-size: 21px;
    padding: 14px 24px;
  }

  /** Drop overlay **/
  div.overlaytext {
    background-color:black;
    color:white;  
    opacity:0.6; /* transparency */  
    filter:alpha(opacity=60); /* IE transparency */  
  }

  </style>
  <!-- Load FreeDOM and point it to the root module -->
  <script type="text/javascript"
      src="/freedom.js"
      data-manifest="manifest.json">
    {
      "stayLocal": true,
      "debug": true,
      "strongIsolation": true
    }
  </script>
</head>
<body>
  <div class="container-narrow">
    <div class="masthead">
      <h3 class="muted">FreeDOM File Drop</h3>
    </div>
    <hr>
    <!-- Main drop box for files-->
    <div id='drop' class="jumbotron">
      <h1>Send a File</h1>
      <p id='dropstatus' class="lead">Drag a file into this square to send a file</p>
      <p>Note: Only supports 1 file at a time, so zip it up yourself!</p>
      <img width='20%' src='file.png'/>
    </div>

    <!-- Display file transfer status -->
    <h4 id='servingheader'> Actively serving: </h4>
    <div id="stats">
    </div>

    <!-- Modal for after file is uploaded -->
    <div id='dropModal' class="modal hide fade">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Let's do this!</h3>
      </div>
      <div class="modal-body">
        <div class="progress progress-striped">
          <div id='dropProgress' class="bar" style="width: 0%;"></div>
        </div>
        <p id='dropMessage'></p>
        <input id='dropUrl' class='input-xxlarge' type="text" readonly>
      </div>
      <div class="modal-footer">
        <button id='closeModal' type="button" class="btn btn-primary">Close</a>
      </div>
    </div>
  </div>
</body>

<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script type="text/javascript">
  // After loading freedom.js, the window is populated with a 'freedom'
  // object, which is used as a message passing channel to the root module
  window.onload = function() {
    if (!window.FileReader) {
      document.body.innerHTML = "Your browser does not support HTML5 FileReader";
    }

    document.getElementById('closeModal').onclick = function() {
      $('#dropModal').modal('hide');
    };
    
    function fileError(e) {
      var errorMsg = 'An error occurred while reading this file';
      switch(evt.target.error.code) {
        case evt.target.error.NOT_FOUND_ERR:
          errorMsg = 'File Not Found!';
          break;
        case evt.target.error.NOT_READABLE_ERR:
          errorMsg = 'File is not readable';
          break;
        case evt.target.error.ABORT_ERR:
          break; // noop
      };
      $('#dropMessage').text(errorMsg);
    }

    function fileLoad(evt) {
      $('#dropProgress').css('width' , "100%");
      console.log("READ DONE");
      window.freedom.emit('serve-data', evt.target.result);
    }

    function fileProgress(evt) {
      if (evt.lengthComputable) {
        var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
        if (percentLoaded < 100) {
          $('#dropProgress').css('width', percentLoaded + "%");
        }
      }
    }

    function handleFile(e) {
      e = e || window.event; // get window.event if e argument missing (in IE)   
      if (e.preventDefault) { e.preventDefault(); } // stops the browser from redirecting off to the image.
      var dt = e.originalEvent.dataTransfer;
      var files = dt.files;
      var file = files[0];
      var reader = new FileReader();
      reader.onload = fileLoad;
      reader.onerror = fileError;
      reader.onprogress = fileProgress;
      reader.onloadstart = function(evt) {
        //Get rid of the overlay
        within_dragenter = false;
        $("#drop").removeClass('overlaytext');
        //Show our drop modal
        $('#dropModal').modal({});
      };
      reader.readAsArrayBuffer(file);
      return false;
    }

    var within_dragenter = false;
    $(document.body).bind('dragenter', function(e) {
      if (e.preventDefault) { e.preventDefault(); }
      within_dragenter = true;
      setTimeout(function() {within_dragenter=false;},0);
      $("#drop").addClass('overlaytext');
    });
    $(document.body).bind('dragover', function(e) {
      if (e.preventDefault) { e.preventDefault(); }
    });
    $(document.body).bind('dragleave', function(e) {
      if (! within_dragenter) {
        $("#drop").removeClass('overlaytext');
      }
      within_dragenter = false;
    });
    $(document.body).bind('drop', handleFile);

    window.freedom.on('serve-url', function(val) {
      var displayUrl = window.location + "#" + JSON.stringify(val);
      var key = val.key;
      $("#dropMessage").text("Share the following URL with your friends. Don't be a jerk, keep this tab open while file transfer is happening");
      $("#dropUrl").val(displayUrl);
      //Create a new stat monitor
      $("#servingheader").show();
      var div = document.createElement('div');
      var input = document.createElement('input');
      input.className = 'input-xxlarge';
      input.type = 'text';
      input.readOnly = true;
      input.value = displayUrl;
      var stat = document.createElement('div');
      stat.id = val.key;
      div.appendChild(input);
      div.appendChild(stat);
      div.appendChild(document.createElement('br'));
      $("#stats").append(div);
    });

    window.freedom.on('serve-error', function(val) {
      $("#dropMessage").text(val);
    });

    window.freedom.on('stats', function(val) {
      var elt = document.getElementById(val.key)
      while (elt.hasChildNodes()) {
        elt.removeChild(lastChild);
      }
      elt.appendChild(document.createElement('p').appendChild(document.createTextNode('Downloads in Progress: ' + val.inprogress)));
      elt.appendChild(document.createElement('br'));
      elt.appendChild(document.createElement('p').appendChild(document.createTextNode('Downloads Completed: ' + val.done)));
    });

    try {
      var hash = JSON.parse(window.location.hash.substr(1));
      freedom.emit('download', hash);
    } catch (e) {
      console.log("No parseable hash. Don't download");
    }
    $("#servingheader").hide();   
  }
  </script>
</html>

