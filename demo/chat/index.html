<!DOCTYPE html>
<html lang='en-US'>
<head>
  <title>Chat ~ freedom.js Demos</title>
  <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
  <link href='../style.css' rel='stylesheet' type='text/css' />
  <!-- Include freedom.js, pass it the manifest, and a set of options -->
  <script type='text/javascript'
      src='../../freedom.js'
      data-manifest='manifest.json'>
  {
    "strongIsolation": true,
    "stayLocal": true,
    "debug": true
  }
  </script>

  <script type='text/javascript'>
  window.onload = function() {
    document.getElementById('msg-input').focus();
    // If messages are going to a specific user, store that here.
    var activeId;

    function clearLog() {
      var log = document.getElementById('messagelist');
      log.innerHTML = "";
    }

    function appendLog(elt) {
      var log = document.getElementById('messagelist');
      //Trim old messages
      while (log.childNodes.length > 36) {
        log.removeChild(log.firstChild);
      }
      log.appendChild(elt);
      var br = document.createElement('br');
      log.appendChild(br);
      br.scrollIntoView();
    }

    // on changes to the buddylist, redraw entire buddylist
    window.freedom.on('recv-buddylist', function(val) {
      var buddylist = document.getElementById('buddylist');
      // Remove all elements in there now
      buddylist.innerHTML = "<b>Buddylist</b>";

      // Create a new element for each buddy
      for (var i in val) {
        var child = document.createElement('div');
        child.innerHTML = val[i];
        // If the user clicks on a buddy, change our current destination for messages
        child.addEventListener('click', function(jid, child) {
          if (activeId != jid) {
            activeId = jid;
            child.innerHTML = "[" + val[i] + "]";
          } else {
            activeId = undefined;
            child.innerHTML = val[i];
          }
          console.log("Messages will be sent to: " + activeId);
          document.getElementById('msg-input').focus();
        }.bind(this, val[i], child), true);
        buddylist.appendChild(child);
      }
    });
    // On new messages, append it to our message log
    window.freedom.on('recv-message', function(data) {
      var message = data.fromUserId + ": " + data.message;
      appendLog(document.createTextNode(message));
    });

    // Display our own userId when we get it
    window.freedom.on('recv-uid', function(data) {
      document.getElementById('uid').innerText = "Logged in as: "+data;
    });

    // Display the current status of our connection to the Social provider
    window.freedom.on('recv-status', function(msg) {
      if (msg && msg == 'online') {
        document.getElementById('msg-input').disabled = false;
      } else {
        document.getElementById('msg-input').disabled = true;
      }
      clearLog();
      var elt = document.createElement('b');
      elt.appendChild(document.createTextNode('Status: ' + msg));
      appendLog(elt);
    });

    // Listen for the enter key and send messages on return
    var input = document.getElementById('msg-input');
    input.onkeydown = function(evt) {
      if (evt.keyCode == 13) {
        var text = input.value;
        input.value = "";
        appendLog(document.createTextNode("You: " + text));
        window.freedom.emit('send-message', {to: activeId, message: text});
      }
    };
  }
  </script>

  <style type='text/css'>
  section {border: 1px solid black; position:relative; display: inline-block; vertical-align:top;}
  #uid {font-family: helvetica; float:left;}
  #buddylist {padding: 5px; margin-left:-5px; min-width: 150px;}
  #msg-input {width:700px; margin:0;}
  #messagelist {height: 400px; overflow-y: scroll; padding-left: 5px;}
  </style>
</head>

<body>
  <header id='logo'>freedom.js</header>
  <header><span id='triangle'>&#9654;</span> Demos</header>
  <header><span id='triangle'>&#9654;</span> Chat</header>
  <div style='clear:both; height:15px;'></div>
  <section>
    <div id='messagelist' class='text'></div>
    <div id='uid'>Logging In</div>
    <input id='msg-input' type='text' placeholder='Type message here'/>
  </section>
  <section id='buddylist'>
  </section>
</body>
</html>
