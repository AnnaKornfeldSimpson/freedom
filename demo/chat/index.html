<!DOCTYPE html>
<html lang='en-US'>
<head>
  <title>WebRTC Chat Demo</title>
  <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
  <script type='text/javascript'
      src='/freedom.js'
      data-manifest='manifest.json'>
  </script>
  <script type='text/javascript'>
  window.onload = function() {
    var activeId;
    window.freedom.on('recv-buddylist', function(val) {
      val = val[0];
      var buddylist = document.getElementById('buddylist');
      while(buddylist.hasChildNodes()) {
        buddylist.removeChild(buddylist.lastChild);
      }
      for (var i in val) {
        var child = document.createElement('div');
        child.innerHTML = val[i];
        child.addEventListener('click', function(jid) {
          activeId = jid;
          console.log("Messages will be sent to: " + activeId);
          document.getElementById('status').innerText = "Active connection to " + activeId;
        }.bind(this, val[i]), true);
        buddylist.appendChild(child);
      }
    });
    window.freedom.on('recv-message', function(data) {
      var log = document.getElementById('messagelist');
      if (log.childNodes.length) {
        log.insertBefore(document.createElement('br'), log.childNodes[0]);
        log.insertBefore(document.createTextNode(data), log.childNodes[0]);
      } else {
        log.appendChild(document.createTextNode(data));
      }
    });
    window.freedom.on('recv-uid', function(data) {
      document.getElementById('uid').innerText = "UID:"+data;
    });
    
    var input = document.getElementById('msg-input');
    input.onkeydown = function(evt) {
      if (evt.keyCode == 13) {
        var text = input.value;
        input.value = "";
        window.freedom.emit('send-message', {to: activeId, msg: text});
      }
    };
  }
  </script>
</head>
<body>
  <input id='msg-input' type='text'/>
  <div id='uid'>No UID</div>
  <div id='status'>Status: No active connection</div>
  <div id='buddylist'></div>
  <br>
  <div id='log-banner'><b>Chat messages:</b></div>
  <div id='messagelist' class='text'></div>
</body>
</html>
