<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/misc/api.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: src/misc/api.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>define(["thirdparty/require", "thirdparty/underscore", "thirdparty/backbone", "constants", "channel", "interface"],
function(require, _, backbone, constants, channel, iface) {
	"use strict";

	/**
	 * Make a call over the serialized channel to the parent frame,
	 * passing a token.  Then register a callback listener waiting for that token
	 * to be passed back so that a callback can be executed.
	 */
	function _call(method, args, callback) {
		var token = new Uint8Array(16);
		window.crypto.getRandomValues(token);

		var response = function(msg) {
			if (msg.source == window.parent && msg.data &&
				  msg.data.token && _.isEqual(msg.data.token, token)) {
  			window.removeEventListener('message', response, true);
	  		callback(msg.data.response);
			}
		};

		// TODO(willscott): Don't hardcode dependence on the parent.
		// Should be usable from untrusted web as well.
		window.addEventListener('message', response, true);
		window.parent.postMessage({token: token, method: method, args: args}, '*');
	}
	
	var channels = {};
	
	/**
	 * Register a global event listener for messsages sent on named channels.
	 */
 	// TODO(willscott): don't hardcode dependence on the parent.
	window.addEventListener('message', function(msg) {
		if (msg.source == window.parent && msg.data &&
				msg.data.channel && msg.data.channel in channels) {
					channels[msg.data.channel].trigger("message", msg.data.message);
		}
	}, true);
	
	/**
	 * Register a new named channel with a given ID, return the channel.
	 */
	function _registerChannel(channelId) {
		if (channelId in channels) {
			console.warn("channel '" + channelId + "' was already registered.");
			return false;
		}
		channels[channelId] = new channel.SerializedChannel({"sendMessage": function(msg) {
			_call(channelId, msg, function() {});
		}});
		return channels[channelId];
	}

	/**
	 * Load Providers into the API from the controller.
	 */
	function _loadProviders(api, callback) {
		_call(constants.API.getProviders, {}, function(resp) {
			api.providers = resp;
			callback();
		});
	};
	
	/**
	 * Creates the Public FreeDOM Interface.
	 */
	function API(v) {
		var self = this;
		self._version = v;

    // Make the API an event target.
		_.extend(self, backbone.Events);
		
		_loadProviders(self, function() {});
	};
	
	/**
	 * Application Lifecycle & Communication Events.
	 */
	API.prototype.events = {
		//TODO(willscott): figure out naming of events. Probably worth a class.
		READY: "freedomready"
	};
	
	/**
	 * Registered API Providers.
	 */
	API.prototype.providers = {};

	/**
	 * Request a provider.  The callback will be provided with
	 * the API interface to that provider.
	 * arguments are preferences for configuring the supplied provider.
	 */
	API.prototype.getProvider = function(provider, args, callback) {
		if (!_.contains(this.providers, provider)) {
			callback(null);
		}

		_call(constants.API.establishChannel, {method: provider, args: args}, function(channelId) {
			require([provider], function(def) {
				var chan = _registerChannel(channelId);
				callback(iface.createStub(def, chan));
			});				
		});
	};
		
	return {API: API};
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="api.html">api</a></li><li><a href="fdom.app.External.html">External</a></li><li><a href="fdom.app.Internal.html">Internal</a></li><li><a href="fdom.Proxy.html">Proxy</a></li><li><a href="fdom.Proxy.messageChannel.html">messageChannel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#conform">conform</a></li><li><a href="global.html#eachProp">eachProp</a></li><li><a href="global.html#eachReverse">eachReverse</a></li><li><a href="global.html#handleEvents">handleEvents</a></li><li><a href="global.html#isAppContext">isAppContext</a></li><li><a href="global.html#makeAbsolute">makeAbsolute</a></li><li><a href="global.html#mixin">mixin</a></li><li><a href="global.html#scripts">scripts</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#Storage_unprivileged">Storage_unprivileged</a></li><li><a href="global.html#this['emit']">this['emit']</a></li><li><a href="global.html#Transport_unprivileged">Transport_unprivileged</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#View_unprivileged">View_unprivileged</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Thu Mar 14 2013 12:02:49 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
