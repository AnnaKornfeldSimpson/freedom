<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/proxy/templatedProxy.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: src/proxy/templatedProxy.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>fdom.Proxy.templatedProxy = function(channel, definition) {
  var inflight = {};
  var events = null;
  var emitter = null;
  var self = this;
  var id = Math.random();

  eachProp(definition, function(prop, name) {
    switch(prop['type']) {
      case "property":
        //TODO(willscott): how should asyncronous properties work?
        break;
      case "method":
        this[name] = function() {
          channel.postMessage({
            'action': 'method',
            'type': name,
            'id': id,
            'value': conform(prop.value, arguments)
          });
          var deferred = fdom.Proxy.Deferred();
          inflight[id] = deferred;
          id++;
          return deferred['promise']();
        }
        break;
      case "event":
        if(!events) {
          handleEvents(this);
          emitter = this['emit'];
          delete this['emit'];
          events = {};
        }
        events[name] = prop;
        break
    }
  }.bind(this));

  channel['on']('message', function(msg) {
    if (!msg) return;
    if (msg.action == 'method') {
      if (inflight[msg.id]) {
        var deferred = inflight[msg.id];
        delete inflight[msg.id];
        deferred['resolve'](msg.value);
      } else {
        console.log("Dropped response message with id " + msg.id);
      }
    } else if (msg.action == 'event') {
      var prop = events[msg.type];
      if (prop) {
        var val = conform(prop.value, msg.value);
        emitter(msg.type, val);
      }
    }
  });
};

/**
 * Force a collection of values to look like the types and length of an API template.
 */
function conform(template, value) {
  switch(template) {
    case "string":
      return "" + value;
    case "number":
      return 0 + value;
    case "bool":
      return false | value;
    case "object":
      // TODO(willscott): Allow removal if sandboxing enforces this.
      return JSON.parse(JSON.stringify(value));
  }
  if (Array.isArray(template)) {
    var val = [];
    if (template.length == 2 && template[0] == "array") {
      //console.log("template is array, value is " + JSON.stringify(value));
      for (var i = 0; i &lt; value.length; i++) {
        val.push(conform(template[1], value[i]));
      }
    } else {
      for (var i = 0; i &lt; template.length; i++) {
        if (value[i]) val.push(conform(template[i], value[i]))
        else val.push(undefined);
      }
    }
    return val;
  } else if (typeof template === "object") {
    var val = {};
    eachProp(template, function(prop, name) {
      if (value[name]) {
        val[name] = conform(prop, value[name]);
      };
    });
    return val;
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="api.html">api</a></li><li><a href="fdom.app.External.html">External</a></li><li><a href="fdom.app.Internal.html">Internal</a></li><li><a href="fdom.Proxy.html">Proxy</a></li><li><a href="fdom.Proxy.messageChannel.html">messageChannel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#conform">conform</a></li><li><a href="global.html#eachProp">eachProp</a></li><li><a href="global.html#eachReverse">eachReverse</a></li><li><a href="global.html#handleEvents">handleEvents</a></li><li><a href="global.html#isAppContext">isAppContext</a></li><li><a href="global.html#makeAbsolute">makeAbsolute</a></li><li><a href="global.html#mixin">mixin</a></li><li><a href="global.html#scripts">scripts</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#Storage_unprivileged">Storage_unprivileged</a></li><li><a href="global.html#this['emit']">this['emit']</a></li><li><a href="global.html#Transport_unprivileged">Transport_unprivileged</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#View_unprivileged">View_unprivileged</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Thu Mar 14 2013 12:02:49 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
