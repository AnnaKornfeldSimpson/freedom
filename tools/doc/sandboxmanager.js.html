<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/misc/sandboxmanager.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: src/misc/sandboxmanager.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>define(["dommanager", "hub"],
function(dom, hub) {
	"use strict";
	
	var state = {
		LOADING: 0,
		LOADED: 1,
		RUNNING: 2
	};
	
	// TODO(willscott): Document the communication channel between frames.
	var version = 1.0;

	/**
	 * Create a new sandbox with a given identifier.
	 */
	function SandboxManager(id) {
		var self = this;
		self._id = id;
		self._state = state.LOADING;
    //TODO(ryscheng): replace with webworkers
		self._el = dom.create("iframe");
		self._el.src = chrome.extension.getURL("sandbox.html");
		self._listener = listener.bind(this, id);
		window.addEventListener('message', self._listener, true);
	};
	
	// Listen for messages from the sandbox.
	function listener(id, msg) {
		if (msg.source == this._el.contentWindow) {
			if (this._state == state.LOADING && msg.data == "LOADED") {
				this.post({version: version, app: id});
				this._state = state.LOADED;
			} else if (this._state == state.LOADED && msg.data == "RUNNING") {
				this._state = state.RUNNING;
				
				// Forward messages to the FreeDOM Core.
			} else if (this._state != state.LOADING) {
				if("method" in msg.data && "token" in msg.data) {
					// Ask the Hub For Data.
				  var resp = hub.req(msg.data["method"], id, msg.data.args);

					// Callback responds to the frame with the result of it's request.
					var callback = function(response) {
						this.post({token: msg.data["token"], response: response});
					};

					// The Hub may want to call 'postOnChannel' to establish a named
					// channel to the frame.
					if (typeof resp == "function") {
						resp(this, callback.bind(this));
					} else {
						callback.call(this);
					}
				}
			}
		}
	}
	
	// Send a message to the sandbox.
	SandboxManager.prototype.post = function(msg) {
		this._el.contentWindow.postMessage(msg, '*');
	};
	
	// Create a function for sending to the sandbox with an extra identifier.
	SandboxManager.prototype.postOnChannel = function(channel) {
		var sendMsg = function(msg) {
			this.post({channel: channel, message: msg});
		};
		return sendMsg.bind(this);
	};

	/**
	 * Removal notification for a sandbox.
	 */
	SandboxManager.prototype.remove = function() {
		console.log("Sandbox removed for " + this._id);
		window.removeEventListener('message', this._listener, true);
		dom.remove(this._el);
	};
	
	return SandboxManager;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="api.html">api</a></li><li><a href="fdom.app.External.html">External</a></li><li><a href="fdom.app.Internal.html">Internal</a></li><li><a href="fdom.Proxy.html">Proxy</a></li><li><a href="fdom.Proxy.messageChannel.html">messageChannel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#conform">conform</a></li><li><a href="global.html#eachProp">eachProp</a></li><li><a href="global.html#eachReverse">eachReverse</a></li><li><a href="global.html#handleEvents">handleEvents</a></li><li><a href="global.html#isAppContext">isAppContext</a></li><li><a href="global.html#makeAbsolute">makeAbsolute</a></li><li><a href="global.html#mixin">mixin</a></li><li><a href="global.html#scripts">scripts</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#Storage_unprivileged">Storage_unprivileged</a></li><li><a href="global.html#this['emit']">this['emit']</a></li><li><a href="global.html#Transport_unprivileged">Transport_unprivileged</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#View_unprivileged">View_unprivileged</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Thu Mar 14 2013 12:02:49 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
