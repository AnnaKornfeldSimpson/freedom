<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: providers/transport.unprivileged.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: providers/transport.unprivileged.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/**
 * A FreeDOM transport provider using WebRTC
 */
var Transport_unprivileged = function(channel) {
  this.nextId = 10;
  this.channel = channel;
  this.rtcConnections = {};
  this.rtcChannels = {};
  handleEvents(this);
};

Transport_unprivileged.prototype.onStateChange = function(id) {
  var sendChannel = this.rtcChannels[id];
  console.log(id + " send channel's state:"+sendChannel.readyState);
  this.channel.postMessage({
    'action':'event',
    'type': 'onStateChange',
    'value': {id: id, state: sendChannel.readyState}
  });
};

Transport_unprivileged.prototype.onMessage = function(id, evt) {
  console.log(id + " message: "+evt.data);
  this.channel.postMessage({
    'action':'event',
    'type': 'onMessage',
    'value': {id: id, message: evt.data}
  });
};

Transport_unprivileged.prototype.onIceCandidate = function(id, evt) {
  console.log(evt);
  /**
  console.log(id + " icecandidate: "+JSON.stringify(evt));
  this.channel.postMessage({
    'action': 'event',
    'type': 'onSignal',
    'value': {id: id, message: JSON.stringify(evt.candidate)}
  });
  **/
}

Transport_unprivileged.prototype.create = function (continuation) {
  var sockId = this.nextId++;
  var servers = null;
  var sendChannel;
  var pc = new webkitRTCPeerConnection(servers,
                {optional: [{RtpDataChannels: true}]});
  this.rtcConnections[sockId] = pc;
  try {
    sendChannel = pc.createDataChannel("sendDataChannel", {reliable: false});
    this.rtcChannels[sockId] = sendChannel;
  } catch (e) {
    console.warn('Failed to create data channel. You need Chrome M25' +
                  'or later with --enable-data-channels flag');
  }
  sendChannel.onopen = this.onStateChange.bind(this,sockId);
  sendChannel.onclose = this.onStateChange.bind(this,sockId);
  sendChannel.onmessage = this.onMessage.bind(this,sockId);
  pc.onicecandidate = this.onIceCandidate.bind(this,sockId);
  
  pc.createOffer(function(desc) {
    pc.setLocalDescription(desc);
    continuation({id: sockId, offer: JSON.stringify(desc)});
  });
};

Transport_unprivileged.prototype.accept = function (id, strdesc, continuation) {
  var parseddesc = JSON.parse(strdesc);
  if (parseddesc.type == 'candidate') {
    var candidate = new RTCIceCandidate({sdpMLineIndex: parseddesc.label,
                                        candidate: parseddesc.candidate});
    this.rtcConnections[id].addIceCandidate(candidate);
    console.log("Successfully accepted ICE candidate");
  //} else if (id == null || !(id in this.rtcConnections)) {
  } else if (parseddesc.type == 'offer') {
    var desc = new RTCSessionDescription(parseddesc);
    var sockId = this.nextId++;
    var servers = null;
    var pc = new webkitRTCPeerConnection(servers, 
                  {optional: [{RtpDataChannels: true}]});
    this.rtcConnections[sockId] = pc;
    pc.onicecandidate = this.onIceCandidate.bind(this,sockId);
    pc.ondatachannel = function(evt) {
      var channel = evt.channel;
      this.rtcChannels[sockId] = channel;
      channel.onopen = this.onStateChange.bind(this,sockId);
      channel.onclose = this.onStateChange.bind(this,sockId);
      channel.onmessage = this.onMessage.bind(this,sockId);
    }.bind(this);
    //desc, successCallback, failureCallback
    pc.setRemoteDescription(desc,
      function(){console.log("Successfully set remote description");}, 
      function(){console.log("Failed set remote description");});
    pc.createAnswer(function(answer) {
      pc.setLocalDescription(answer);
      continuation({id: sockId, offer: JSON.stringify(answer)});
    });
  } else if (parseddesc.type == 'answer') {
    var desc = new RTCSessionDescription(parseddesc);
    this.rtcConnections[id].setRemoteDescription(desc, 
      function(){console.log("Successfully set remote description");}, 
      function(){console.log("Failed set remote description");});
    continuation();
  } else if (parseddesc.type == 'bye') {
    this.close(id);
  }
};

Transport_unprivileged.prototype.send = function (id, msg, continuation) {
  this.rtcChannels[id].send(msg);
  continuation();
};

Transport_unprivileged.prototype.close = function (id, continuation) {
  this.rtcChannels[id].close();
  this.rtcConnections[id].close();
  delete this.rtcChannels[id];
  delete this.rtcConnections[id];
  continuation();
};

Transport_unprivileged.prototype.get = function(key, continuation) {
  try {
    var val = localTransport[this.channel.app.id + key];
    continuation(val);
  } catch(e) {
    continuation(null);
  }
};

Transport_unprivileged.prototype.set = function(key, value, continuation) {
  localTransport[this.channel.app.id + key] = value;
  continuation();
};

fdom.apis.register("core.transport", Transport_unprivileged);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="api.html">api</a></li><li><a href="fdom.app.External.html">External</a></li><li><a href="fdom.app.Internal.html">Internal</a></li><li><a href="fdom.Proxy.html">Proxy</a></li><li><a href="fdom.Proxy.messageChannel.html">messageChannel</a></li></ul><h3>Global</h3><ul><li><a href="global.html#conform">conform</a></li><li><a href="global.html#eachProp">eachProp</a></li><li><a href="global.html#eachReverse">eachReverse</a></li><li><a href="global.html#handleEvents">handleEvents</a></li><li><a href="global.html#isAppContext">isAppContext</a></li><li><a href="global.html#makeAbsolute">makeAbsolute</a></li><li><a href="global.html#mixin">mixin</a></li><li><a href="global.html#scripts">scripts</a></li><li><a href="global.html#setup">setup</a></li><li><a href="global.html#Storage_unprivileged">Storage_unprivileged</a></li><li><a href="global.html#this['emit']">this['emit']</a></li><li><a href="global.html#Transport_unprivileged">Transport_unprivileged</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#View_unprivileged">View_unprivileged</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Thu Mar 14 2013 12:02:49 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
